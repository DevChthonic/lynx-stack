# Contributing

Contributions are always welcome, no matter how large or small!

## Developing

_Node_: Check that Node is [installed](https://nodejs.org/en/download/) with version `>= 22`. You can check this with `node -v`.

_pnpm_: Make sure that pnpm is available. You can use `corepack enable` to automatically setup pnpm.

_Rust_: ReactLynx utilizes SWC plugins, necessitating the Rust toolchain for building.

- Ensure you have [`rustup`](https://rustup.rs/) installed.
- Install the required toolchain and WASM target by running the following command from _any_ directory (you only need to do this once):
  ```sh
  rustup toolchain install 1.81.0 --profile minimal --target wasm32-unknown-unknown
  ```
- `rustup` will automatically use the correct toolchain when you run build commands inside this project, thanks to the `rust-toolchain` file.

### Setup

To setup the project, run:

```sh
pnpm install
```

### Building

This project uses a combination of TypeScript, Rust, and custom build tools across multiple packages. A full build requires orchestration using Turborepo.

- **Full Workspace Build (Required for Tests):**
  To perform a complete build of all packages, including compiling Rust code (WASM/NAPI) and running all necessary package-specific build scripts (`rslib`, `rsbuild`, etc.), **use Turborepo**:

  ```sh
  pnpm exec turbo run build
  ```
  _(Note: The existing `pnpm turbo build` command might also work if configured similarly in the root package.json, but `pnpm exec turbo run build` is explicit.)_

  This command respects the dependency graph, handles all necessary compilation steps, and utilizes caching for faster subsequent builds. **This full build is required before running the test suite (`pnpm test`).**

- **TypeScript Compilation Only (Optional):**
  The `pnpm build` script in the root `package.json` is an alias for `tsc --build`. This command uses TypeScript's [Project References](https://www.typescriptlang.org/docs/handbook/project-references.html#handbook-content) to compile TypeScript files and check types across the workspace.

  ```sh
  pnpm build
  ```
  This command is **not sufficient** for a complete build or for running tests, as it does not handle Rust compilation or other necessary build steps. It might be useful for quick TypeScript-only checks.

- **Build with Watching (TypeScript Only):**
  To incrementally build TypeScript files on change using `tsc`:
  ```sh
  pnpm build --watch
  ```
  _(Note: This likely does not watch or rebuild Rust components or run other non-tsc build steps.)_

### Running linting/tests

#### Lint

```sh
pnpm eslint .
```

- You can run eslint's auto-fix via:

```sh
pnpm eslint --fix .
```

#### Tests for all packages via [`vitest`](https://vitest.dev/):

```sh
pnpm test
```

#### Run tests for a specific package

When working on an issue, you will most likely want to focus on a particular packages. Using `--project` will only run tests for that specific package.

```sh
pnpm run test --project websocket
```

#### Run tests for a group of packages

You may also run tests of multiple projects together.

```sh
pnpm run test --project 'webpack/*'
```

#### Run a subset of tests

Pass the name of test suite to `pnpm test` to run a subset of tests by name:

```sh
pnpm run test server
```

<details>
  <summary>More options</summary>
  You can also use <code>describe.only</code> or <code>test.only</code> to select suites and tests.

```diff
-  test('run with webpack-dev-server', async () => {
+  test.only('run with webpack-dev-server', async () => {
```

</details>
<br>

#### Run test with Node debugger

Quick way to debug tests in VS Code is via `JavaScript Debug Terminal`.
Open a new `JavaScript Debug Terminal` and run `pnpm vitest`.
_This works with any code ran in Node, so will work with most JS testing frameworks._

See [Debugging Vitest](https://vitest.dev/guide/debugging.html) for more details.

You can combine debug with `--project` or `.only` to debug a subset of tests. If you plan to stay long in the debugger (which you'll likely do!), you may increase the test timeout by setting `--test-timeout`.

To overwrite any test fixtures when fixing a bug or anything, add the `--update`

```sh
pnpm run test --project websocket --update
```

#### Test coverage

To test the code coverage, use `--coverage`:

```sh
pnpm run test --coverage
```

### Writing API References

Each package should have its own API reference documentation.
It is generated by the comments of the public APIs using [API Extractor].

#### Update API References

To update the API reference, just run:

```bash
turbo api-extractor -- --local
```

This will update the `<projectFolder>/etc` which describe all the public APIs.
You should always commit the change to git.

## Submitting

### Generating changesets

We use [ðŸ¦‹ Changesets](https://github.com/changesets/changesets?tab=readme-ov-file) to manage versioning and changelogs.
Usually, you need to generate changeset(s) for your changes.

Just run:

```sh
pnpm changeset
```

Then select the correct packages with desired versions.
See [Adding a changeset](https://github.com/changesets/changesets/blob/main/docs/adding-a-changeset.md) for details.

Then commit the generated `.md` file in `.changeset/` and submit a PR on GitHub.

[API Extractor]: https://api-extractor.com/
[`turborepo`]: https://turbo.build/repo
